---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sysdigcloud-mysql-config
  namespace: {{ .Values.namespace }}
  labels:
    app: sysdigcloud
data:
  my.cnf: |-
    [client]
    port   = 3306
    socket   = /var/run/mysqld/mysqld.sock
    default-character-set=utf8

    [mysql]
    default-character-set=utf8
    [mysqld_safe]
    pid-file = /var/run/mysqld/mysqld.pid
    socket   = /var/run/mysqld/mysqld.sock
    nice   = 0
    [mysqld]
    user   = mysql
    pid-file = /var/run/mysqld/mysqld.pid
    socket   = /var/run/mysqld/mysqld.sock
    port   = 3306
    basedir    = /usr
    datadir    = /var/lib/mysql
    tmpdir   = /tmp
    lc-messages-dir  = /usr/share/mysql
    explicit_defaults_for_timestamp
    collation-server = utf8_unicode_ci
    init-connect='SET NAMES utf8'
    character-set-server = utf8
    log-error  = /var/log/mysql/error.log
    # Recommended in standard MySQL setup
    sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
    # Disabling symbolic-links is recommended to prevent assorted security risks
    symbolic-links=0
    # This increase of max_connections from the default of 151 to 1024 has been
    # tested as adequate for an environment with up to 24 API/Worker/Collector
    # components (8 of each) and 4000 Agents of incoming traffic. The MySQL
    # container also consumed as much as 1 GB of memory in this test.
    max_connections=1024
    !includedir /etc/mysql/conf.d/
---
apiVersion: v1
kind: Service
metadata:
  name: sysdigcloud-mysql
  namespace: {{ .Values.namespace }}
  labels:
    app: sysdigcloud
    role: mysql
spec:
  ports:
    - port: 3306
  selector:
    app: sysdigcloud
    role: mysql
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sysdigcloud-mysql
  namespace: {{ .Values.namespace }}
  labels:
    app: sysdigcloud
    role: mysql
spec:
  selector:
    matchLabels:
      app: sysdigcloud
      role: mysql
  serviceName: sysdigcloud-mysql-cluster
  template:
    metadata:
      labels:
        app: sysdigcloud
        role: mysql
    spec:
      containers:
        - name: mysql
          image: {{ .Values.airgapped_registry_name | default "quay.io" }}/sysdig/mysql:5.6.43.2
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: sysdigcloud-config
                  key: mysql.password
            - name: MYSQL_USER
              valueFrom:
                configMapKeyRef:
                  name: sysdigcloud-config
                  key: mysql.user
            - name: MYSQL_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: sysdigcloud-config
                  key: mysql.password
            - name: MYSQL_DATABASE
              value: draios
            - name: MYSQL_EXTRADB_SCANNING_DBNAME
              valueFrom:
                configMapKeyRef:
                  name: sysdigcloud-config
                  key: scanning.mysql.dbname
            - name: MYSQL_EXTRADB_SCANNING_USER
              valueFrom:
                configMapKeyRef:
                  name: sysdigcloud-config
                  key: scanning.mysql.user
            - name: MYSQL_EXTRADB_SCANNING_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sysdigcloud-scanning
                  key: scanning.mysql.password
          volumeMounts:
            - name: mysql-config
              mountPath: /etc/mysql/my.cnf
              subPath: my.cnf
            - name: data
              mountPath: /var/lib/mysql
      imagePullSecrets:
        - name: sysdigcloud-pull-secret
      volumes:
        - name: mysql-config
          configMap:
            name: sysdigcloud-mysql-config
